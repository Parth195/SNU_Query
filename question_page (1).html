<!DOCTYPE html>
<html>

<head>
    <title>Fetch Questions</title>
    <style>
        /* Basic styling for the question list */
        #questionList {
            list-style: none;
            padding: 0;
        }

        #questionList li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
            position: relative;
        }

        .vote-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* Style for the answer form */
        #answerForm {
            margin-top: 20px;
        }

        #answerForm input {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }

        #answerForm button {
            padding: 8px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        /* Style for the answers list */
        #answersList {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        #answersList li {
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #eee;
            position: relative;
        }

        .vote-buttons-answer {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .vote-count {
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <h1>Questions:</h1>
    <ul id="questionList"></ul>

    <!-- Answer form -->
    <div id="answerForm" style="display: none;">
        <h2>Answering the selected question:</h2>
        <input type="text" id="answerText" placeholder="Your answer"><br>
        <input type="text" id="answerAuthor" placeholder="Your name"><br>
        <button type="submit" id="postAnswer"> Post Answer</button>
        <ul id="answersList"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, runTransaction } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDr8S2OmDIo5EsNU97uJWq3gQlqv8zitAI",
            authDomain: "snu-query.firebaseapp.com",
            databaseURL: "https://snu-query-default-rtdb.firebaseio.com",
            projectId: "snu-query",
            storageBucket: "snu-query.appspot.com",
            messagingSenderId: "350908354215",
            appId: "1:350908354215:web:146b8142a7db2549f15582",
            measurementId: "G-T7426ZGZWQ"
        };
        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const database = getDatabase(firebaseApp);
        const questionsRef = ref(database, "questions");

        const questionList = document.getElementById("questionList");
        let selectedQuestionId = null;

        // Function to fetch and display questions
        function fetchQuestions() {
            onValue(questionsRef, (snapshot) => {
                questionList.innerHTML = ''; // Clear the list

                const questions = snapshot.val();

                if (questions) {
                    for (const questionKey in questions) {
                        if (questions.hasOwnProperty(questionKey)) {
                            const question = questions[questionKey];
                            const listItem = document.createElement("li");
                            const tags = question.tags.join(", ");
                            listItem.textContent = `Author: ${question.author}, Question: ${question.text}, Tags: ${tags}, Timestamp: ${question.timestamp}`;
                            listItem.appendChild(createVoteButtons('question', questionKey, question.votes));
                            listItem.onclick = () => showQuestionAndAnswers(questionKey, question);
                            questionList.appendChild(listItem);
                        }
                    }
                }
            }, (error) => {
                console.error("Error fetching questions:", error);
            });
        }

        // Function to create vote buttons
        function createVoteButtons(type, entityId, votes) {
            const voteDiv = document.createElement('div');
            voteDiv.className = `vote-buttons-${type}`;
            const upvoteBtn = document.createElement('button');
            upvoteBtn.textContent = 'Upvote';
            const downvoteBtn = document.createElement('button');
            downvoteBtn.textContent = 'Downvote';

            const voteCount = document.createElement('span');
            voteCount.className = 'vote-count';
            voteCount.textContent = `Upvotes: ${votes?.upvote || 0}, Downvotes: ${votes?.downvote || 0}`;

            upvoteBtn.onclick = () => handleVote(type, entityId, 'upvote');
            downvoteBtn.onclick = () => handleVote(type, entityId, 'downvote');

            voteDiv.appendChild(upvoteBtn);
            voteDiv.appendChild(downvoteBtn);
            voteDiv.appendChild(voteCount);

            return voteDiv;
        }

        // Function to handle voting
        function handleVote(type, entityId, voteType) {
            const userId = 'unique_user_id'; // Replace with actual user ID logic
            const voteRef = ref(database, `votes/${type}/${entityId}/${userId}`);
            const entityRef = ref(database, `questions/${entityId}`);

            runTransaction(entityRef, (entity) => {
                if (!entity.votes) {
                    entity.votes = {};
                }

                // Check if the user already voted
                const userVote = entity.votes[userId];

                if (userVote === voteType) {
                    // If the user's existing vote matches the current action, cancel the vote
                    delete entity.votes[userId];
                } else {
                    // Set/Update the user's vote
                    entity.votes[userId] = voteType;
                }
                return entity;
            }).then(() => {
                console.log(`Voted ${voteType} on ${type} ${entityId}`);
                alert(`Voted ${voteType} successfully!`);
            }).catch((error) => {
                console.error("Error voting:", error);
            });
        }



        // Function to show the question and existing answers
        function showQuestionAndAnswers(questionId, question) {
            selectedQuestionId = questionId;
            const answerForm = document.getElementById('answerForm');
            answerForm.style.display = 'block';

            const answersList = document.getElementById('answersList');
            answersList.innerHTML = ''; // Clear previous answers

            // Display the question text
            const questionText = document.createElement('li');
            questionText.textContent = `Question: ${question.text}`;
            answersList.appendChild(questionText);

            // Display existing answers if available
            const answersRef = ref(database, `questions/${questionId}/answers`);
            onValue(answersRef, (snapshot) => {
                const answers = snapshot.val();
                if (answers) {
                    for (const answerKey in answers) {
                        if (answers.hasOwnProperty(answerKey)) {
                            const answer = answers[answerKey];
                            const answerItem = document.createElement('li');
                            answerItem.textContent = `Answer by ${answer.answerAuthor}: ${answer.answerText}`;
                            answerItem.appendChild(createVoteButtons('answer', answerKey, answer.votes));
                            answersList.appendChild(answerItem);
                        }
                    }
                }
            }, (error) => {
                console.error("Error fetching answers:", error);
            });
        }

        function getSelectedQuestionId() {
            return selectedQuestionId;
        }

        function handlePostAnswerClick() {
            postAnswer();
        }

        // Add an event listener to the post answer button
        const postAnswerButton = document.getElementById("postAnswer");
        postAnswerButton.addEventListener("click", handlePostAnswerClick);

        function postAnswer() {
            const selectedQuestionId = getSelectedQuestionId();
            const answerText = document.getElementById("answerText").value;
            const answerAuthor = document.getElementById("answerAuthor").value;

            // Perform form validation
            if (selectedQuestionId && answerText && answerAuthor) {
                // All fields are filled, proceed with posting the answer
                const answersRef = ref(database, `questions/${selectedQuestionId}/answers`);
                const newAnswerRef = push(answersRef, {
                    answerText: answerText,
                    answerAuthor: answerAuthor,
                    timestamp: new Date().toISOString(),
                    votes: { upvote: 0, downvote: 0 } // Initialize votes for the answer
                }).then(() => {
                    console.log("Answer posted successfully!");
                    alert("Answer posted successfully!");
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }).catch((error) => {
                    console.error("Error posting answer: ", error);
                });
            } else {
                alert("Please fill in all fields to post the answer.");
            }
        }

        // Call the function to fetch questions
        fetchQuestions();
    </script>
</body>

</html>